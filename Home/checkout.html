<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout â€¢ ShopHub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #6366f1; --purple: #a78bfa; --radius: 24px; --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', sans-serif; background: #000; color: white; min-height: 100vh; }
    .navbar { background: rgba(0,0,0,0.7); backdrop-filter: blur(12px); padding: 1rem 2rem; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
    .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 2rem; font-weight: 900; background: linear-gradient(90deg, #6366f1, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-links a { color: white; text-decoration: none; font-weight: 600; margin-left: 2rem; opacity: 0.9; }
    .nav-links a:hover { opacity: 1; color: var(--primary); }
    .checkout-wrapper {
      max-width: 1400px; margin: 0 auto; padding: 130px 2rem 8rem;
      display: grid; grid-template-columns: 1fr 500px; gap: 6rem; align-items: start;
    }
    @media (max-width: 1100px) {
      .checkout-wrapper { grid-template-columns: 1fr; gap: 4rem; }
      .order-summary { position: static; order: -1; }
    }
    h1 { font-size: 5rem; font-weight: 900; background: linear-gradient(90deg, #fff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2rem; }
    .section-title { font-size: 1.35rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin: 3rem 0 1.5rem; opacity: 0.9; }
   
    .input-group {
      margin-bottom: 1.6rem;
    }
    label {
      display: block;
      margin-bottom: 0.7rem;
      font-weight: 600;
      color: #fff;
      opacity: 0.95;
    }
    input, select {
      width: 100%;
      padding: 1.4rem 1.8rem;
      background: rgba(20, 20, 40, 0.88);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 18px;
      color: #ffffff !important;
      font-size: 1.05rem;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transition: all 0.3s ease;
    }
    input::placeholder {
      color: rgba(255, 255, 255, 0.55) !important;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
      background: rgba(20, 20, 40, 0.95);
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .back-link { display: inline-flex; align-items: center; gap: 0.6rem; color: #aaa; text-decoration: none; font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
    .back-link:hover { color: white; }
    .discount-box { display: flex; gap: 1rem; margin: 2rem 0; }
    .apply-btn { padding: 0 2rem; background: var(--primary); border: none; border-radius: 18px; color: white; font-weight: 800; cursor: pointer; transition: var(--transition); }
    .apply-btn:hover { background: #818cf8; }
    .order-summary {
      background: #0f0f0f; border-radius: var(--radius); padding: 2.5rem;
      box-shadow: 0 20px 70px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.08);
      position: sticky; top: 100px; height: fit-content;
    }
    .cart-item { display: flex; gap: 1.2rem; padding: 1.4rem 0; border-bottom: 1px solid #1a1a1a; }
    .cart-item img { width: 96px; height: 140px; object-fit: cover; border-radius: 16px; }
    .item-info h4 { margin: 0 0 0.4rem; font-size: 1.1rem; }
    .item-price { color: var(--purple); font-weight: 800; margin-top: 0.5rem; }
    .total-row { display: flex; justify-content: space-between; margin: 1rem 0; font-size: 1.2rem; }
    .grand-total { font-size: 2rem; font-weight: 900; color: var(--purple); border-top: 2px solid #333; padding-top: 1.4rem; margin-top: 1.4rem; }
    .pay-btn {
      width: 100%; padding: 1.6rem; margin-top: 2rem;
      background: linear-gradient(135deg, var(--primary), var(--purple));
      color: white; border: none; border-radius: 50px; font-size: 1.5rem; font-weight: 800;
      cursor: pointer; box-shadow: 0 15px 40px rgba(99,102,241,0.5); transition: var(--transition);
    }
    .pay-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none !important; }
    .pay-btn:hover:not(:disabled) { transform: translateY(-5px); box-shadow: 0 25px 60px rgba(99,102,241,0.6); }
    .security { display: flex; justify-content: center; gap: 2rem; margin-top: 2.5rem; opacity: 0.7; font-size: 2rem; }
    .demo-banner {
      background: #4ade80; color: white; text-align: center; padding: 0.8rem; font-weight: bold; font-size: 0.95rem;
    }
    .payment-info { padding: 1.4rem 1.8rem; background: rgba(20, 20, 40, 0.88); border-radius: 18px; border: 1px solid rgba(255,255,255,0.18); }
    .payment-info p { opacity: 0.9; line-height: 1.6; }
  </style>
</head>
<body>
  <div class="demo-banner">
    âœ… Prices now in MWK â€¢ OneKhusa Payments (Redirect Flow) â€¢ Orders Save & Cart Empties
  </div>
  <nav class="navbar">
    <div class="nav-container">
      <a href="../index.html" class="logo">ShopHub</a>
      <div class="nav-links"><a href="../index.html">Continue Shopping</a></div>
    </div>
  </nav>
  <div class="checkout-wrapper">
    <div>
      <a href="../index.html" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Vault
      </a>
      <h1>CHECKOUT</h1>
      <div class="section-title">Contact Information</div>
      <div class="input-group">
        <label>Email Address</label>
        <input type="email" id="email" placeholder="you@example.com" required />
      </div>
      <div class="section-title">Shipping Address</div>
      <div class="row">
        <div class="input-group"><label>First Name</label><input type="text" id="first-name" required /></div>
        <div class="input-group"><label>Last Name</label><input type="text" id="last-name" required /></div>
      </div>
      <div class="input-group"><label>Street Address</label><input type="text" id="address" required /></div>
      <div class="input-group"><label>Apt, suite, etc (optional)</label><input type="text" id="apt" /></div>
      <div class="row">
        <div class="input-group"><label>City</label><input type="text" id="city" required /></div>
        <div class="input-group"><label>Postal Code</label><input type="text" id="postal" required /></div>
      </div>
      <div class="row">
        <div class="input-group">
          <label for="country">Country</label>
          <select id="country">
            <option value="Malawi" selected>Malawi</option>
          </select>
        </div>
        <div class="input-group"><label>Phone</label><input type="tel" id="phone" placeholder="+265 ..." /></div>
      </div>
      <div class="section-title">Payment</div>
      <div class="input-group">
  <label for="payment-method">Select Payment Method</label>
  <select id="payment-method" required>
    <option value="">Choose a payment method</option>
    <option value="airtel_money">Airtel Money</option>
    <option value="tnm_mpamba">TNM Mpamba</option>
    <option value="bank_card">Bank Card</option>
  </select>
</div>

      <div class="input-group">
        <label>Secure Payment via OneKhusa</label>
        <div class="payment-info">
          <p>You will be redirected to OneKhusa's secure payment page to complete your order in MWK.</p>
          <p>Supports: Airtel Money, Mpamba, Bank Cards, National Bank Mo626, and more.</p>
        </div>
      </div>
    </div>
    <div class="order-summary">
      <div class="summary-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h2>ORDER SUMMARY</h2>
        <span id="itemCount">0 items</span>
      </div>
      <div id="checkoutItems"></div>
      <div class="discount-box">
        <input type="text" id="discountCode" placeholder="Discount code" />
        <button class="apply-btn" onclick="applyDiscount()">APPLY</button>
      </div>
      <div id="discountMessage" style="margin-top:0.5rem; min-height: 24px;"></div>
      <div class="summary-totals">
        <div class="total-row"><span>Subtotal</span><span id="subtotal">MWK 0.00</span></div>
        <div class="total-row"><span>Discount</span><span id="discountAmount">-MWK 0.00</span></div>
        <div class="total-row"><span>Shipping</span><span>FREE</span></div>
        <div class="total-row"><span>Tax</span><span id="tax">MWK 0.00</span></div>
        <div class="total-row grand-total"><span>TOTAL</span><span id="grandTotal">MWK 0.00</span></div>
      </div>
      <button class="pay-btn" id="submit">
        <span id="button-text">PROCEED TO PAYMENT</span>
        <span id="spinner" style="display:none;">PROCESSING...</span>
      </button>
      <div class="security">
        <i class="fas fa-shield-alt"></i>
        <i class="fas fa-mobile-alt"></i>
        <i class="fas fa-credit-card"></i>
        <i class="fas fa-university"></i>
      </div>
    </div>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ðŸš€ ShopHub Checkout - MWK Prices + OneKhusa Integration');

  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oeXVjYmdqb2Ntd3JrcWJqam1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzNjAsImV4cCI6MjA3OTA3MDM2MH0.uu5ZzSf1CHnt_l4TKNIxWoVN_2YCCoxEZiilB1Xz0eE';
  const supabaseClient = supabase.createClient(
    'https://nhyucbgjocmwrkqbjjme.supabase.co',
    supabaseKey
  );

  // Login check
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session || !session.user) {
    localStorage.setItem("redirect_after_login", "checkout.html");
    window.location.href = "../Admin/adLogin.html";
    return;
  }

  // Load profile
  const { data: profile } = await supabaseClient
    .from("profiles")
    .select("*")
    .eq("id", session.user.id)
    .single();
  window.customerId = profile?.id || 1;
  if (profile) {
    document.getElementById("email").value = profile.email || "";
    document.getElementById("first-name").value = profile.first_name || "";
    document.getElementById("last-name").value = profile.last_name || "";
    document.getElementById("phone").value = profile.phone || "";
  }

  // Cart from localStorage
  const cart = JSON.parse(localStorage.getItem("shophub_cart") || '[]');
  let discount = 0;

  function getPublicImageUrl(path) {
    if (!path) return 'https://i.pinimg.com/736x/4a/d8/f3/4ad8f37a3820e656419f4dd0b417e3c4.jpg';
    if (path.startsWith("http")) return path;
    return `https://nhyucbgjocmwrkqbjjme.supabase.co/storage/v1/object/public/products/${path}`;
  }

  async function getSizesForProduct(productId) {
    const { data } = await supabaseClient
      .from("product_sizes")
      .select("size, stock")
      .eq("product_id", productId)
      .gt("stock", 0)
      .order("size");
    return data || [];
  }

  function formatMWK(amount) {
    return `MWK ${amount.toFixed(2)}`;
  }

  async function renderCart() {
    const container = document.getElementById("checkoutItems");
    if (cart.length === 0) {
      container.innerHTML = "<p style='text-align:center;padding:3rem 0;opacity:0.6;'>Your bag is empty</p>";
      document.getElementById("itemCount").textContent = "0 items";
      document.getElementById("grandTotal").textContent = "MWK 0.00";
      return;
    }

    let html = "";
    for (let index = 0; index < cart.length; index++) {
      const item = cart[index];
      let sizeHtml = "";
      if (item.has_sizes) {
        const sizes = await getSizesForProduct(item.id);
        sizeHtml = `
          <div class="input-group" style="margin-top:0.8rem;">
            <label style="font-size:0.85rem;opacity:0.8;">Select Size</label>
            <select onchange="updateItemSize(${index}, this.value)" style="padding:0.6rem;border-radius:10px;">
              <option value="">Choose size</option>
              ${sizes.map(s => `<option value="${s.size}" ${item.size === s.size ? "selected" : ""}>${s.size}</option>`).join("")}
            </select>
          </div>
        `;
      }
      html += `
        <div class="cart-item">
          <img src="${getPublicImageUrl(item.image_url)}">
          <div class="item-info">
            <h4>${item.name}</h4>
            ${sizeHtml}
            <div>Qty: ${item.quantity}</div>
            <div class="item-price">${formatMWK(item.price * item.quantity)}</div>
          </div>
        </div>
      `;
    }
    container.innerHTML = html;

    const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);
    document.getElementById("itemCount").textContent = `${totalItems} item${totalItems !== 1 ? "s" : ""}`;

    const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
    const tax = subtotal * 0.16; // VAT in Malawi is 16%
    const total = subtotal - discount + tax;

    document.getElementById("subtotal").textContent = formatMWK(subtotal);
    document.getElementById("discountAmount").textContent = `- ${formatMWK(discount)}`;
    document.getElementById("tax").textContent = formatMWK(tax);
    document.getElementById("grandTotal").textContent = formatMWK(total);
  }

  window.updateItemSize = function (index, size) {
    cart[index].size = size;
    localStorage.setItem("shophub_cart", JSON.stringify(cart));
  };

  window.applyDiscount = function () {
    const code = document.getElementById("discountCode").value.trim().toUpperCase();
    const msg = document.getElementById("discountMessage");
    if (code === "VAULT20") {
      discount = cart.reduce((s, i) => s + i.price * i.quantity, 0) * 0.20;
      msg.innerHTML = `<div style="color:#4ade80;">20% OFF Applied</div>`;
    } else if (code !== "") {
      discount = 0;
      msg.innerHTML = `<div style="color:#ff6b6b;">Invalid Code</div>`;
    } else {
      discount = 0;
      msg.innerHTML = "";
    }
    renderCart();
  };

 document.getElementById("submit").addEventListener("click", async () => {
  const button = document.getElementById("submit");
  const spinner = document.getElementById("spinner");
  const text = document.getElementById("button-text");

  // Disable button while processing
  button.disabled = true;
  text.style.display = "none";
  spinner.style.display = "inline";

  try {
    // --- Required fields ---
    const email = document.getElementById("email").value.trim();
    const firstName = document.getElementById("first-name").value.trim();
    const lastName = document.getElementById("last-name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const paymentMethod = document.getElementById("payment-method").value;

    if (!email || !firstName || !lastName || !phone) {
      throw new Error("Please fill in all required contact fields.");
    }

    if (!paymentMethod) {
      throw new Error("Please select a payment method.");
    }

    // --- Check product sizes ---
    const missingSize = cart.find(item => item.has_sizes && !item.size);
    if (missingSize) {
      throw new Error(`Please select a size for "${missingSize.name}".`);
    }

    // --- Customer & order data ---
    const customerData = {
      name: `${firstName} ${lastName}`,
      email,
      phone,
      address: document.getElementById("address").value,
      apt: document.getElementById("apt").value,
      city: document.getElementById("city").value,
      postal: document.getElementById("postal").value,
      country: document.getElementById("country").value,
    };

    const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
    const tax = subtotal * 0.16;
    const totalPrice = subtotal - discount + tax;

    // --- Create order in Supabase ---
    const { data: order, error: orderError } = await supabaseClient
      .from('orders')
      .insert([{
        customer_id: window.customerId,
        total: totalPrice,
        status: 'pending',
        payment_method: 'onekhusa',
        shipping_address: JSON.stringify(customerData)
      }])
      .select('id')
      .single();

    if (orderError) throw new Error(`Order creation failed: ${orderError.message}`);

    // --- Insert order items ---
    const orderItems = cart.map(item => ({
      order_id: order.id,
      product_id: item.id,
      quantity: item.quantity,
      price: item.price,
      subtotal: item.price * item.quantity,
      name: item.name,
      image_url: item.image_url,
      size: item.size || null
    }));
    const { error: itemsError } = await supabaseClient.from('order_items').insert(orderItems);
    if (itemsError) throw new Error(`Order items failed: ${itemsError.message}`);

    // --- Call Edge Function for OneKhusa ---
    const res = await fetch(
  "https://nhyucbgjocmwrkqbjjme.supabase.co/functions/v1/oneKhusa-payment-intent",
  {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: totalPrice,
      email,
      phone,
      order_id: order.id,
      method: paymentMethod
    })
  }
);

    const data = await res.json();
    if (data.error) throw new Error(data.error);
    if (!data.payment_url) throw new Error("No payment URL returned");

    // --- Redirect to OneKhusa payment ---
    window.location.href = data.payment_url;

  } catch (err) {
    console.error('Checkout failed:', err);
    alert(`Error: ${err.message}`);
    button.disabled = false;
    text.style.display = "inline";
    spinner.style.display = "none";
  }
});
  renderCart();
});
</script>
</body>
</html>
